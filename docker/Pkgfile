# Description: a platform to build, share and run container applications
# URL: https://docker.com
# Maintainer: skelettz, skelettz at protonmail dot com
# Depends on: libseccomp git go

name=docker
version=v27.3.1
release=1
source=()

build() {
	cd $PKGMK_SOURCE_DIR

	if cd $name-$version; then
		git fetch -q
		git reset --hard $version
	else
		git clone --branch $version https://github.com/moby/moby $name-$version
		cd $name-$version
	fi

	export GOPATH=$SRC

	# install dependencies

	mkdir -pv $PKG/usr/bin

	for dep in containerd runc tini dockercli
	do
		PREFIX=$PKG/usr/bin hack/dockerfile/install/install.sh $dep
	done

	# install

	export DOCKER_BUILDTAGS="seccomp no_systemd exclude_graphdriver_btrfs exclude_graphdriver_devicemapper"
	
	hack/make.sh dynbinary

	install -D -m 0755 bundles/dynbinary-daemon/dockerd $PKG/usr/bin/dockerd
	install -D -m 0755 bundles/dynbinary-daemon/docker-proxy $PKG/usr/bin/docker-proxy
}
